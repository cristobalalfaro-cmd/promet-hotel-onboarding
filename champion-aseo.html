<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Champion · Tutoría Aseo/Mucama</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script defer src="assets/app.js?v=6"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fff;color:#000}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:4px solid #142C54;background:linear-gradient(90deg,#E4E4E3,#fff)}
    .brand{font-weight:800;color:#142C54}
    .contact{font-size:.95rem}
    .badge{background:#F26135;color:#fff;border-radius:999px;padding:4px 8px;font-size:.8rem}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,select,textarea{width:100%;padding:12px;border:2px solid #ccc;border-radius:12px;background:#fff;color:#000;font-size:1rem}
    textarea{min-height:90px}
    fieldset{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    legend{padding:0 6px;font-weight:700;color:#142C54}
    .grid-topics{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .scale{display:flex;gap:14px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    .scale input{display:none}
    .dot{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:50%;border:2px solid #142C54;cursor:pointer}
    input:checked + .dot{background:#142C54;color:#fff}
    .scale-label{ text-align:center; font-weight:700; color:#555; margin-bottom:6px; }
    .actions{display:flex;gap:10px;position:sticky;bottom:0;background:#fff;border-top:1px solid #ddd;padding:12px;margin-top:16px}
    .btn{border:none;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:#142C54;color:#fff}
    .btn-ghost{background:#f6f6f6}
  </style>
</head>
<body>
<header class="header">
  <div class="brand">Champion · Auxiliar de Aseo/Mucama</div>
  <div class="contact">Contacto: <a href="mailto:onboarding@promet.cl">onboarding@promet.cl</a></div>
  <div class="badge">Día: <span id="modTag"></span> · <span id="modTitle"></span></div>
</header>

<!-- Override garantizado de API_URL -->
<script>
  (function(){
    var URL_BACKEND = "https://script.google.com/macros/s/AKfycbz-nlterj3rCyJn8ajkmZRAVxSZEnIUElM0oPyQ3JxdUwKYwbvqM4r8rSJlLiyUJfS0/exec";
    window.PROMET = window.PROMET || {};
    window.PROMET.CONFIG = window.PROMET.CONFIG || {};
    window.PROMET.CONFIG.API_URL = URL_BACKEND;
    window.PROMET.BUILD = "v6c";
  })();
</script>

<div class="container">
  <form id="f" class="card">
    <div class="row">
      <div>
        <label>Nombre del Champion</label>
        <input name="champion" required placeholder="Ej: Juan Pérez" />
      </div>
      <div>
        <label>Fecha de Tutoría</label>
        <input name="fecha" type="date" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Hotel</label>
        <select name="hotel" id="hotel" required></select>
      </div>
      <div>
        <label>RUT del Participante</label>
        <input name="rut" required placeholder="14122472-7" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Nombre del Participante</label>
        <input name="nombre_part" required />
      </div>
      <div>
        <label>Cargo Evaluado</label>
        <input name="cargo" value="Auxiliar de Aseo / Mucama" readonly />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Fase</label>
        <select name="fase" id="fase" required>
          <option value="">Selecciona</option>
          <option value="DIAGNOSTICO">Diagnóstico (sin nota)</option>
          <option value="EVALUACION">Evaluación (con nota)</option>
        </select>
      </div>
      <div>
        <label style="visibility:hidden">.</label>
        <div class="scale-label">Las notas se activan en “Evaluación”</div>
      </div>
    </div>

    <fieldset>
      <legend>Temas del día</legend>
      <div id="topicsWrap"></div>
    </fieldset>

    <label>Comentarios del Champion (opcional)</label>
    <textarea name="comentario" placeholder="..."></textarea>

    <div class="actions">
      <button type="button" class="btn btn-ghost" onclick="history.back()">Volver</button>
      <button class="btn btn-primary">Guardar</button>
    </div>
  </form>
</div>

<footer style="text-align:center;color:#666;margin:24px 0 12px;">© Promet</footer>

<script>
(function(){
  const usp = new URLSearchParams(location.search);
  const k = usp.get('k');              // debe ser CHAMP2025!
  const mod = (usp.get('mod')||'D1').toUpperCase();
  if(!k){ location.href='index.html'; return; }

  document.getElementById('modTag').textContent = mod;
  document.getElementById('modTitle').textContent =
    (window.PROMET?.CONFIG?.MOD_TITLES?.[mod]) || mod;

  // Hotel con fallback robusto
  const selHotel = document.getElementById('hotel');
  if (window.PROMET?.renderHoteles) window.PROMET.renderHoteles(selHotel);
  if (!selHotel.options.length || selHotel.options.length === 1) {
    selHotel.innerHTML = `
      <option value="">Selecciona hotel</option>
      <option>Calama</option>
      <option>Colbún</option>
      <option>Coya</option>
      <option>Engie</option>
      <option>Fidelia</option>
      <option>Mejillones</option>
    `;
  }

  // Render de temas según día
  const topics = (window.PROMET?.CONFIG?.CHAMP_TOPICS?.[mod] || []);
  const topicsWrap = document.getElementById('topicsWrap');
  topicsWrap.innerHTML = topics.map((t,idx)=>`
    <div class="grid-topics" data-topic-index="${idx}">
      <div>${t}</div>
      <div>
        <div class="scale-label">Nota</div>
        <div class="scale" id="sc_${idx}"></div>
      </div>
    </div>
  `).join("");

  // Escalas 1..7
  topics.forEach((_,i)=>{
    if (window.PROMET?.renderScale7) {
      window.PROMET.renderScale7(`n_${i}`, document.getElementById(`sc_${i}`));
    } else {
      // fallback mínimo
      const host = document.getElementById(`sc_${i}`);
      host.innerHTML = [1,2,3,4,5,6,7].map(n =>
        `<label><input type="radio" name="n_${i}" value="${n}" required><span class="dot">${n}</span></label>`
      ).join('');
    }
  });

  // Modo Diagnóstico: deshabilita notas
  const faseSel = document.getElementById('fase');
  function applyFase(){
    const diag = (faseSel.value === 'DIAGNOSTICO');
    topics.forEach((_,i)=>{
      document.querySelectorAll(`input[name="n_${i}"]`).forEach(r=>{
        r.required = !diag;
        r.disabled = diag;
        if(diag) r.checked = false;
      });
    });
  }
  faseSel.addEventListener('change', applyFase);
  applyFase();

  // Fallback apiPost local (text/plain) por si app.js cacheado
  (function ensureApiPost(){
    if (window.PROMET && typeof window.PROMET.apiPost === 'function') return;
    window.PROMET = window.PROMET || {};
    window.PROMET.CONFIG = window.PROMET.CONFIG || {};
    const API_URL = window.PROMET.CONFIG.API_URL;
    window.PROMET.apiPost = async function(route, payload){
      if (!API_URL) throw new Error('API_URL no definida.');
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ route, ...payload })
      });
      if(!res.ok) throw new Error(await res.text() || ('HTTP '+res.status));
      return res.json();
    };
  })();

  // Envío
  const form = document.getElementById('f');
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(form);

    if(!window.PROMET?.validarRUT ? !/^[0-9]{7,8}-[0-9Kk]$/.test(fd.get('rut')) : !window.PROMET.validarRUT(fd.get('rut'))){
      alert('RUT inválido. Formato 14122472-7 (sin puntos).'); return;
    }
    if(fd.get('fase')==='EVALUACION'){
      for(let i=0;i<topics.length;i++){
        if(!fd.get(`n_${i}`)){ alert('Faltan notas por asignar.'); return; }
      }
    }

    const notas = topics.map((t,i)=>({ tema: t, nota: Number(fd.get(`n_${i}`)||0) }));

    try{
      await window.PROMET.apiPost('champion.submit', {
        k, data:{
          mod,
          hotel: fd.get('hotel'),
          fecha: fd.get('fecha'),
          rut: fd.get('rut'),
          nombre_part: (fd.get('nombre_part')||'').trim(),
          cargo: fd.get('cargo'),
          champion: (fd.get('champion')||'').trim(),
          fase: fd.get('fase'),
          notas,
          comentario: fd.get('comentario')||''
        }
      });
      alert('¡Listo! Tutoría registrada.');
      form.reset();
      applyFase();
    }catch(e){
      alert(e.message || 'Error al guardar.');
    }
  });
})();
</script>
</body>
</html>
